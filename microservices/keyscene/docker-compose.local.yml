services:
  keyscene:
    build: .
    ports:
      - "${ENVID_LOCAL_KEYSCENE_PORT:-5085}:5085"
    environment:
      # Optional: mount TransNetV2 weights dir and point TRANSNETV2_MODEL_DIR at it.
      TRANSNETV2_MODEL_DIR: /weights/transnetv2-weights
      PORT: 5085
      CLIP_MODEL: ${ENVID_CLIP_MODEL:-ViT-B-32}
      CLIP_PRETRAINED: ${ENVID_CLIP_PRETRAINED:-laion2b_s34b_b79k}
      XDG_CACHE_HOME: /cache
    volumes:
      # Put your TransNetV2 weights here (see README)
      - ./weights:/weights:ro
      - clip_cache:/cache
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5085/health').read()"]
      interval: 10s
      timeout: 5s
      retries: 12

volumes:
  clip_cache:
