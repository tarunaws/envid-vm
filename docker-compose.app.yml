version: "3.9"

services:
  dns:
    container_name: dns
    build:
      context: .
      dockerfile: metadata/dns/Dockerfile
    image: envid-dns:dev
    restart: always
    ports:
      - "53:53/udp"
      - "53:53/tcp"
    env_file:
      - metadata/dns/.env
    networks:
      envid-net:
        ipv4_address: 172.28.0.2

  gateway:
    container_name: gateway
    build:
      context: .
      dockerfile: metadata/gateway/Dockerfile
    image: envid-gateway:dev
    restart: always
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    ports:
      - "5016:5016"
    dns:
      - 172.28.0.2
    volumes:
      - ./metadata/gateway/envoy.yaml:/etc/envoy/envoy.yaml:ro
    env_file:
      - metadata/gateway/.env
    depends_on:
      - backend
      - keycloak
      - otel-collector
    networks:
      envid-net:
        ipv4_address: 172.28.0.3
        aliases:
          - backend

  backend:
    container_name: backend
    build:
      context: .
      dockerfile: metadata/backend/Dockerfile
    image: envid-metadata-multimodal:dev
    restart: always
    environment:
      PYTHONUNBUFFERED: "1"
      PYTHONPATH: "/app:/app/code"
      ENVID_METADATA_PORT: "5016"
      ENVID_SERVICE_NAME: "backend"
      ENVID_METADATA_LOCAL_MODERATION_URL: "http://local-moderation-nudenet:5081"
      ENVID_METADATA_LOCAL_KEYSCENE_URL: "http://local-keyscene-best:5085"
      FFMPEG_PATH: "/app/code/envidMetadataGCP/ffmpeg_proxy.sh"
      FFPROBE_PATH: "/app/code/envidMetadataGCP/ffprobe_proxy.sh"
      FFMPEG_SERVICE_CONTAINER: "ffmpeg"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    env_file:
      - metadata/backend/.env
      - .env.multimodal.local
      - .env.multimodal.vm.local
    dns:
      - 172.28.0.2
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${GCP_CREDENTIALS_PATH:-/home/tarun-envid/gcp.json}:${GCP_CREDENTIALS_PATH:-/home/tarun-envid/gcp.json}:ro
    networks:
      envid-net:
        ipv4_address: 172.28.0.4

  frontend:
    container_name: frontend
    build:
      context: .
      dockerfile: metadata/frontend/Dockerfile
    image: envid-frontend:dev
    restart: always
    env_file:
      - metadata/frontend/.env
    dns:
      - 172.28.0.2
    networks:
      envid-net:
        ipv4_address: 172.28.0.5

  whisperx-service:
    container_name: whisperx-service
    build:
      context: .
      dockerfile: metadata/whisperx-service/Dockerfile
    image: whisperx-service:dev
    restart: always
    runtime: nvidia
    environment:
      NVIDIA_VISIBLE_DEVICES: "all"
      NVIDIA_DRIVER_CAPABILITIES: "compute,utility"
    env_file:
      - metadata/whisperx-service/.env
    ports:
      - "5088:5088"
    networks:
      envid-net:
        ipv4_address: 172.28.0.6
    dns:
      - 172.28.0.2

  local-moderation-nudenet:
    container_name: local-moderation-nudenet
    build:
      context: .
      dockerfile: metadata/local-moderation-nudenet/Dockerfile
    image: local-moderation-nudenet:dev
    restart: always
    runtime: nvidia
    environment:
      NVIDIA_VISIBLE_DEVICES: "all"
      NVIDIA_DRIVER_CAPABILITIES: "compute,utility"
    env_file:
      - metadata/local-moderation-nudenet/.env
    ports:
      - "5081:5081"
    networks:
      envid-net:
        ipv4_address: 172.28.0.7
    dns:
      - 172.28.0.2

  local-keyscene-best:
    container_name: local-keyscene-best
    build:
      context: .
      dockerfile: metadata/local-keyscene-best/Dockerfile
    image: local-keyscene-best:dev
    restart: always
    runtime: nvidia
    environment:
      NVIDIA_VISIBLE_DEVICES: "all"
      NVIDIA_DRIVER_CAPABILITIES: "compute,utility"
    env_file:
      - metadata/local-keyscene-best/.env
    ports:
      - "5085:5085"
    networks:
      envid-net:
        ipv4_address: 172.28.0.8
    dns:
      - 172.28.0.2

  ffmpeg:
    container_name: ffmpeg
    build:
      context: .
      dockerfile: metadata/ffmpeg/Dockerfile
    image: envid-ffmpeg:dev
    restart: always
    env_file:
      - metadata/ffmpeg/.env
    networks:
      envid-net:
        ipv4_address: 172.28.0.9
    dns:
      - 172.28.0.2

  languagetool:
    container_name: languagetool
    build:
      context: .
      dockerfile: metadata/languagetool/Dockerfile
    image: envid-languagetool:dev
    restart: always
    ports:
      - "8010:8010"
    env_file:
      - metadata/languagetool/.env
    dns:
      - 172.28.0.2
    networks:
      envid-net:
        ipv4_address: 172.28.0.14

  libretranslate-init:
    container_name: libretranslate-init
    build:
      context: .
      dockerfile: metadata/libretranslate-init/Dockerfile
    image: envid-libretranslate-init:dev
    restart: "no"
    entrypoint: ["sh", "-lc", "mkdir -p /home/libretranslate/.local/share/argos-translate /home/libretranslate/.local/cache && chown -R 1000:1000 /home/libretranslate/.local"]
    user: "0:0"
    env_file:
      - metadata/libretranslate-init/.env
    volumes:
      - libretranslate_models:/home/libretranslate/.local/share/argos-translate
      - libretranslate_cache:/home/libretranslate/.local/cache
    dns:
      - 172.28.0.2
    networks:
      envid-net:
        ipv4_address: 172.28.0.15

  libretranslate:
    container_name: libretranslate
    build:
      context: .
      dockerfile: metadata/libretranslate/Dockerfile
    image: envid-libretranslate:dev
    restart: unless-stopped
    depends_on:
      libretranslate-init:
        condition: service_completed_successfully
    env_file:
      - .env
      - metadata/libretranslate/.env
    environment:
      HOME: "/home/libretranslate"
      XDG_DATA_HOME: "/home/libretranslate/.local/share"
      XDG_CACHE_HOME: "/home/libretranslate/.local/cache"
      ARGOS_TRANSLATE_DATA_DIR: "/home/libretranslate/.local/share/argos-translate"
      LT_DISABLE_WEB_UI: "true"
      LT_UPDATE_MODELS: "false"
      LT_LOAD_ONLY: "${LT_LOAD_ONLY}"
      LT_WORKERS: "${LT_WORKERS}"
      LT_BATCH_ENABLED: "${LT_BATCH_ENABLED}"
      LT_BATCH_SIZE: "${LT_BATCH_SIZE}"
      LT_AUTH_TOKEN: "${LT_AUTH_TOKEN}"
    ports:
      - "5000:5000"
    volumes:
      - libretranslate_models:/home/libretranslate/.local/share/argos-translate
      - libretranslate_cache:/home/libretranslate/.local/cache
    user: "0:0"
    cpus: "${LT_CPU_LIMIT}"
    mem_limit: "${LT_MEM_LIMIT}"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/languages').read()"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 30s
    dns:
      - 172.28.0.2
    networks:
      envid-net:
        ipv4_address: 172.28.0.16

  local-ocr-tesseract:
    container_name: local-ocr-tesseract
    build:
      context: .
      dockerfile: metadata/local-ocr-tesseract/Dockerfile
    image: envid-local-ocr-tesseract:dev
    restart: always
    env_file:
      - metadata/local-ocr-tesseract/.env
    dns:
      - 172.28.0.2
    networks:
      envid-net:
        ipv4_address: 172.28.0.17

  keycloak:
    container_name: keycloak
    build:
      context: .
      dockerfile: metadata/keycloak/Dockerfile
    image: envid-keycloak:dev
    restart: always
    environment:
      KEYCLOAK_ADMIN: "admin"
      KEYCLOAK_ADMIN_PASSWORD: "admin"
    command:
      - start-dev
      - --import-realm
    volumes:
      - ./metadata/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    env_file:
      - metadata/keycloak/.env
    ports:
      - "8081:8080"
    networks:
      envid-net:
        ipv4_address: 172.28.0.10
    dns:
      - 172.28.0.2

  jaeger:
    container_name: jaeger
    build:
      context: .
      dockerfile: metadata/jaeger/Dockerfile
    image: envid-jaeger:dev
    restart: always
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    env_file:
      - metadata/jaeger/.env
    ports:
      - "16686:16686"
    networks:
      envid-net:
        ipv4_address: 172.28.0.11
    dns:
      - 172.28.0.2

  otel-collector:
    container_name: otel-collector
    build:
      context: .
      dockerfile: metadata/otel-collector/Dockerfile
    image: envid-otel-collector:dev
    restart: always
    command: ["--config=/etc/otel-collector.yaml"]
    volumes:
      - ./metadata/otel-collector/otel-collector.yaml:/etc/otel-collector.yaml:ro
    env_file:
      - metadata/otel-collector/.env
    ports:
      - "4317:4317"
      - "4318:4318"
    depends_on:
      - jaeger
    networks:
      envid-net:
        ipv4_address: 172.28.0.12
    dns:
      - 172.28.0.2

  nginx:
    container_name: nginx-proxy
    build:
      context: .
      dockerfile: metadata/nginx/Dockerfile
    image: envid-nginx:dev
    restart: always
    depends_on:
      - frontend
      - gateway
    ports:
      - "80:80"
    env_file:
      - metadata/nginx/.env
    networks:
      envid-net:
        ipv4_address: 172.28.0.13
    dns:
      - 172.28.0.2

networks:
  envid-net:
    name: envid-net
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/24

volumes:
  libretranslate_models:
  libretranslate_cache:
